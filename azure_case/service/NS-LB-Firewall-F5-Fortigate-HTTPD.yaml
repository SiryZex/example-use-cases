tosca_definitions_version: cloudify_dsl_1_3

description: >
  Creating load balancing rule on BIG-IP LTM to allow traffic forwarding

imports:
  - http://www.getcloudify.org/spec/cloudify/4.5/types.yaml
  - plugin:cloudify-utilities-plugin

inputs:
  f5_prov_deployment_name:
    default: VNFM-F5-Prov-Azure-vm

  fg_conf_deployment_name:
    default: VNFM-Fortigate-Conf

  httpd_prov_deployment_name:
    default: VNFM-HTTPD-Prov-Azure-vm

  lb_public_port:
    description: >
      Load balancer public network port on which service is exposed 
    type: integer
    default: 8080

  wan_port:
    type: string
    description: >
      Port on which service is going to be exposed
    default: '8080'

dsl_definitions:

  terminal_auth: &terminal_auth
    user: { get_secret: bigip_username }
    password: { get_secret: bigip_password }
    ip: { get_capability: [ {get_input: f5_prov_deployment_name}, mgmt_public_ip ] }
    promt_check:
      - '#'
      - '$'
    errors:
      - "Command fail."

node_templates:

  fg_port_forwarding:
    type: cloudify.terminal.raw
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            terminal_auth: &fg_terminal_auth
              user: { get_secret: fortigate_username }
              password: { get_secret: fortigate_password }
              ip: { get_capability: [ { get_input: fg_conf_deployment_name }, mgmt_public_ip] }
              promt_check:
                - '#'
                - '$'
              errors:
                - "Command fail."
            calls:
              - action: exit
        start:
          inputs:
            terminal_auth: *fg_terminal_auth
            calls:
              - template: Resources/templates/fortigate-portforward-start.txt
                params:
                  PORTFORWARD_IP: { get_capability: [ { get_input: httpd_prov_deployment_name }, lan_ip] }
                  PORTFORWARD_PORT: { get_input: wan_port }
                  EXTERNAL_IP: { get_capability: [ { get_input: fg_conf_deployment_name }, wan_ip] }
        stop:
          inputs:
            terminal_auth: *fg_terminal_auth
            calls:
              - template: Resources/templates/fortigate-portforward-stop.txt

  ltm_config:
    type: cloudify.terminal.raw
    interfaces:
      cloudify.interfaces.lifecycle:
        start:
          inputs:
            terminal_auth: *terminal_auth
            calls:
              - template: Resources/templates/ltm_config.txt
                params:
                  APP_NODE_1_IP: { get_capability: [ {get_input: fg_conf_deployment_name}, wan_ip ] }
                  APP_NODE_1_PORT: { get_input: wan_port }
                  DESTINATION_IP: { get_capability: [ {get_input: f5_prov_deployment_name}, public_ip ] }
                  DESTINATION_PORT: { get_input: lb_public_port }
        stop:
          inputs:
            terminal_auth: *terminal_auth
            calls:
              - template: Resources/templates/ltm_config_stop.txt
    relationships:
      - type: cloudify.relationships.depends_on
        target: fg_port_forwarding


outputs:
  web_server:
    value: { concat: [ { get_capability: [ {get_input: f5_prov_deployment_name}, public_public_ip ] }, ':', {get_input: lb_public_port} ] }